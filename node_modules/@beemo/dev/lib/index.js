'use strict';

const core = require('@beemo/core');

const EXTS = ['.ts', '.tsx'];
const DIRS = ['src', 'tests'];

function hasNoParams(context, name) {
  const params = context.args.params;
  return params.length === 0 || params.length === 1 && params[0] === name;
}

function dev(tool) {
  const usingTypeScript = tool.driverRegistry.isRegistered('typescript');
  const workspacePrefixes = tool.project.getWorkspaceGlobs({
    relative: true
  }); // Babel

  tool.onRunDriver.listen(context => {
    context.addOption('--copy-files');

    if (usingTypeScript && !context.getRiskyOption('extensions')) {
      context.addOption('--extensions', EXTS.join(','));
    }

    if (hasNoParams(context, 'babel')) {
      context.addParam(DIRS[0]);
      context.addOption('--out-dir', context.getRiskyOption('esm') ? 'esm' : 'lib');
    }
  }, 'babel'); // ESLint

  tool.onRunDriver.listen(context => {
    context.addOptions(['--cache', '--color', '--fix']);

    if (usingTypeScript && !context.getRiskyOption('ext')) {
      context.addOption('--ext', EXTS.join(','));
    }

    if (hasNoParams(context, 'eslint')) {
      if (workspacePrefixes.length > 0) {
        workspacePrefixes.forEach(wsPrefix => {
          context.addParam(new core.Path(wsPrefix, `{${DIRS.join(',')}}`).path());
        });
      } else {
        context.addParams(DIRS);
      }
    } // Generate prettier config for the prettier rules


    if (tool.driverRegistry.isRegistered('prettier')) {
      context.addDriverDependency(tool.driverRegistry.get('prettier'));
    } // Generate typescript config for the typescript rules


    if (usingTypeScript) {
      context.addDriverDependency(tool.driverRegistry.get('typescript'));
    }
  }, 'eslint'); // Jest

  tool.onRunDriver.listen((context, driver) => {
    context.addOptions(['--colors', '--logHeapUsage']);
    const env = {
      NODE_ENV: 'test',
      TZ: 'UTC'
    }; // https://jestjs.io/docs/ecmascript-modules

    if (tool.config.settings.esm) {
      var _process$env$NODE_OPT;

      env.NODE_OPTIONS = `--experimental-vm-modules ${(_process$env$NODE_OPT = process.env.NODE_OPTIONS) !== null && _process$env$NODE_OPT !== void 0 ? _process$env$NODE_OPT : ''}`.trim();
    }

    driver.configure({
      env
    }); // Generate babel config to transform files

    if (tool.driverRegistry.isRegistered('babel')) {
      context.addDriverDependency(tool.driverRegistry.get('babel'));
    }
  }, 'jest'); // Prettier

  tool.onRunDriver.listen(context => {
    if (hasNoParams(context, 'prettier')) {
      context.addOption('--write');
      context.addParam('.');
    }
  }, 'prettier');
}

module.exports = dev;
//# sourceMappingURL=index.js.map
